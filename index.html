
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Tim Taubert - Open Source enthusiast. JavaScript lover. Mozillian.</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    
    <meta name="description" content="getUserMedia() part 2: building an EyeToy-like mini-game October, 18th 2012 This post is a follow-up to my previous one about
building a live green &hellip;">
    <meta content="Tim Taubert" name="author">
    <link href="http://fonts.googleapis.com/css?family=Droid+Sans:400,700|PT+Sans" media="screen" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/screen.css" media="screen" rel="stylesheet" type="text/css">
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]-->
    <link href="/favicon.ico" rel="icon" type="image/ico">
    <link href="/atom.xml" rel="alternate" title="Tim Taubert" type="application/atom+xml">
    <script defer src="/javascripts/main.js"></script>
  </head>


<body>
  <div class="container-fluid">
    <div class="row-fluid">
      <div class="col span3">
        <header id="header">
  <h1><a href="/">Tim Taubert</a></h1>
  <a href="https://twitter.com/ttaubert" class="twitter-follow-button" data-show-count="false">Follow @ttaubert</a>
  <script defer>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</header>

        <section id="about">
  <h1 class="hidden">About me</h1>
  <strong>Open Source enthusiast.</strong>
  <strong>JavaScript lover.</strong>
  <strong>Mozillian.</strong>
</section>

        <nav>
  <h1 class="hidden">Main Navigation</h1>
  <ul class="nav-main">
    <li><a class="nav-main-link" title="About me" href="/about-me">about me</a></li>
    <li><a class="nav-main-link" title="Imprint" href="/imprint">imprint</a></li>
  </ul>
</nav>

      </div>
      <div id="main" class="col span6">
        <section>
          <h1 class="hidden">Content</h1>
          


  <article class="post">
  <header class="article-header">
    
      <h1><a href="/blog/2012/10/getusermedia-part-2-building-an-eyetoy-like-mini-game/" title="getUserMedia() part 2: building an EyeToy-like mini-game">getUserMedia() part 2: building an EyeToy-like mini-game</a></h1>
    
    








  



<time datetime="2012-10-18T22:00:00+02:00" pubdate data-updated="true">October, 18<span>th</span> 2012</time>
  </header>
  <p>This post is a follow-up to my previous one about
<a href="/blog/2012/10/building-a-live-green-screen-with-getusermedia-and-mediastreams/">building a live green screen with getUserMedia() and MediaStreams</a>.
If you have not read it yet, this might be a good time. We will extend the small
example to build an EyeToy-like mini-game.</p>

<h2>Some additions</h2>

<figure class='code'> <div class="highlight"><pre><span class="kd">let</span> <span class="nx">GreenScreen</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// Keep track of revealed pixels.</span>
  <span class="nx">revealed</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">(),</span>

  <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</pre>
</div>
</figure>


<p>Let us add a
<a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/Set">Set</a>
to <em>GreenScreen</em> that keeps track of all pixels that have already been
revealed by holding a green object in front of the camera.</p>

<figure class='code'> <div class="highlight"><pre>    <span class="c1">// Iterate over all pixels in the current frame.</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// This pixel has already been revealed.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">revealed</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">frame</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
</pre>
</div>
</figure>


<p>When iterating over all of the canvas&#8217; pixels we check if the current index is
contained in the set. If so we do not need to check its color but set its
opacity to zero and continue with the next iteration.</p>

<figure class='code'> <div class="highlight"><pre>      <span class="c1">// Convert from RGB to HSL...</span>
      <span class="kd">let</span> <span class="p">[</span><span class="nx">h</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">rgb2hsl</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">b</span><span class="p">);</span>

      <span class="c1">// ... and check if we have a somewhat green pixel.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">h</span> <span class="o">&gt;=</span> <span class="mi">90</span> <span class="o">&amp;&amp;</span> <span class="nx">h</span> <span class="o">&lt;=</span> <span class="mi">160</span> <span class="o">&amp;&amp;</span>
          <span class="nx">s</span> <span class="o">&gt;=</span> <span class="mi">25</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span> <span class="o">&lt;=</span> <span class="mi">90</span> <span class="o">&amp;&amp;</span>
          <span class="nx">l</span> <span class="o">&gt;=</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> <span class="nx">l</span> <span class="o">&lt;=</span> <span class="mi">75</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">frame</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">revealed</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
      <span class="p">}</span>
</pre>
</div>
</figure>


<p>If the pixel is not in the set but is a green one, we make it transparent like
before and add it to the set to make it stay that way.</p>

<h2>Demo and screencast</h2>

<p>That is all! Take a look at the <a href="/demos/eye-toy/">live demo</a> or watch the
screencast below:</p>

<iframe class="embed"
 src="http://player.vimeo.com/video/51703468?title=1&amp;byline=1&amp;portrait=1"
 width="500" height="195" frameborder="0"
 webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>


<h2>I know&#8230;</h2>

<p>&#8230; this is not much of a game but rather a small demo one could turn into a
mini-game with little effort. Play around with the code and see what you can
come up with!</p>

</article>



  <article class="post">
  <header class="article-header">
    
      <h1><a href="/blog/2012/10/building-a-live-green-screen-with-getusermedia-and-mediastreams/" title="Building a live green screen with getUserMedia() and MediaStreams">Building a live green screen with getUserMedia() and MediaStreams</a></h1>
    
    








  



<time datetime="2012-10-17T20:00:00+02:00" pubdate data-updated="true">October, 17<span>th</span> 2012</time>
  </header>
  <p>While recently watching a talk about the new WebRTC features I was reminded of
Paul Rouget&#8217;s great
<a href="https://developer.mozilla.org/samples/video/chroma-key/index.xhtml">green screen demo</a>
and thought that this would be a cool thing to have for live video as well.
Let&#8217;s build a live green screen!</p>

<h2>The markup</h2>

<figure class='code'> <div class="highlight"><pre><span class="nt">&lt;body</span> <span class="na">onload=</span><span class="s">&quot;GreenScreen.start()&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;video</span> <span class="na">id=</span><span class="s">&quot;v&quot;</span> <span class="na">width=</span><span class="s">&quot;320&quot;</span> <span class="na">height=</span><span class="s">&quot;240&quot;</span><span class="nt">&gt;&lt;/video&gt;</span>
  <span class="nt">&lt;canvas</span> <span class="na">id=</span><span class="s">&quot;c&quot;</span> <span class="na">width=</span><span class="s">&quot;320&quot;</span> <span class="na">height=</span><span class="s">&quot;240&quot;</span><span class="nt">&gt;&lt;/canvas&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</pre>
</div>
</figure>


<p>Those are the parts we need. A &lt;video> element that plays the media stream
and a canvas we will use to read and transform image data.</p>

<h2>The JavaScript</h2>

<figure class='code'> <div class="highlight"><pre><span class="kd">let</span> <span class="nx">GreenScreen</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Get the video stream.</span>
    <span class="nx">navigator</span><span class="p">.</span><span class="nx">mozGetUserMedia</span><span class="p">({</span><span class="nx">video</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">video</span><span class="p">.</span><span class="nx">mozSrcObject</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">video</span><span class="p">.</span><span class="nx">play</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">();</span>
    <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="kd">function</span> <span class="nx">err</span><span class="p">()</span> <span class="p">{});</span>
  <span class="p">},</span>
</pre>
</div>
</figure>


<p>We call getUserMedia() and pass <em>{video: true}</em> as the first argument which
indicates that we want to receive a video stream. We assign the MediaStream
to the video&#8217;s <em>.src</em> property to connect it to the &lt;video> element.</p>

<p>The video starts playing (which means the camera will be activated and you will
see your webcam&#8217;s live video) and we request an animation frame using the
<a href="https://developer.mozilla.org/en-US/docs/DOM/window.requestAnimationFrame">requestAnimationFrame() API</a>:</p>

<figure class='code'> <div class="highlight"><pre>  <span class="nx">requestAnimationFrame</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">mozRequestAnimationFrame</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">draw</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
  <span class="p">},</span>
</pre>
</div>
</figure>


<p>requestAnimationFrame() is perfect for updating/ drawing to our canvas as the
browser schedules the next repaint and we will be called immediately before
that happens. Now for the last and most important part of our green screen:</p>

<figure class='code'> <div class="highlight"><pre>  <span class="nx">draw</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">video</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">frame</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">getImageData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">frame</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

    <span class="c1">// Iterate over all pixels in the current frame.</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">frame</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">0</span><span class="p">];</span>
      <span class="kd">let</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">frame</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
      <span class="kd">let</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">frame</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>

      <span class="c1">// Convert from RGB to HSL...</span>
      <span class="kd">let</span> <span class="p">[</span><span class="nx">h</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">rgb2hsl</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">b</span><span class="p">);</span>

      <span class="c1">// ... and check if we have a somewhat green pixel.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">h</span> <span class="o">&gt;=</span> <span class="mi">90</span> <span class="o">&amp;&amp;</span> <span class="nx">h</span> <span class="o">&lt;=</span> <span class="mi">160</span> <span class="o">&amp;&amp;</span>
          <span class="nx">s</span> <span class="o">&gt;=</span> <span class="mi">25</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span> <span class="o">&lt;=</span> <span class="mi">90</span> <span class="o">&amp;&amp;</span>
          <span class="nx">l</span> <span class="o">&gt;=</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> <span class="nx">l</span> <span class="o">&lt;=</span> <span class="mi">75</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">frame</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">putImageData</span><span class="p">(</span><span class="nx">frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">();</span>
  <span class="p">},</span>
</pre>
</div>
</figure>


<p>What happens here is actually quite simple: we draw the current video frame
to our canvas and extract its image data. We then iterate over all pixels in
the frame and check if we found a green pixel - if so its opacity byte is set
to zero, which means fully transparent. The manipulated image data is put back
into the canvas and we are done for now until the next animation frame is ready.</p>

<h2>The demo</h2>

<p>Take a look a the <a href="/demos/green-screen/">live demo</a>. You will need Firefox 18+
and thus Nightly or Aurora as of the time of writing. Make sure that
<em>media.navigator.enabled</em> is set to <em>true</em>. Hold a green object in front of the
the camera and try it out yourself. Your camera and light setup is probably very
different from mine so you might need to adjust the color check a little to
make it work. Alternatively, here is a screencast of the demo:</p>

<iframe class="embed"
 src="http://player.vimeo.com/video/51593914?title=1&amp;byline=1&amp;portrait=1"
 width="500" height="191" frameborder="0"
 webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>


<h2>The end</h2>

<p>This is an admittedly very simple example of a green screen but you can use
this little template to manipulate your webcam&#8217;s live video stream and build all
kinds of fancy demos with it.</p>

</article>



  <article class="post">
  <header class="article-header">
    
      <h1><a href="/blog/2012/09/force-octopress-jekyll-to-use-a-specific-time-zone/" title="Force Octopress/Jekyll to use a specific time zone">Force Octopress/Jekyll to use a specific time zone</a></h1>
    
    








  



<time datetime="2012-09-25T15:00:00+02:00" pubdate data-updated="true">September, 25<span>th</span> 2012</time>
  </header>
  <p>I could not be happier ever since I switched from Wordpress to Octopress.
I usually write and publish blog posts from where I live, Berlin. The time zone
here is CET (UTC+1). While recently visiting Mozilla&#8217;s HQ in Mountain View I
wrote another blog post just as usual and typed &#8220;rake generate&#8221; to turn my
Markdown files into static HTML files.</p>

<p>Looking at the output though, got me a little puzzled. All timestamps were
changed to be calculated off the PDT time zone. While certainly that is not a
big deal as they are still the same timestamps, I did not feel like changing
all of those every now and then I am somewhere in a different time zone.</p>

<p>If you want to use a &#8220;static&#8221; time zone when generating your page, do it like
this:</p>

<figure class='code'> <div class="highlight"><pre>TZ=CET rake generate
</pre>
</div>
</figure>


<p><strong>TL;DR</strong> - put your time zone into the TZ variable if you want to force Jekyll
to use a specific time zone when generating your HTML files.</p>

</article>



  <article class="post">
  <header class="article-header">
    
      <h1><a href="/blog/2012/09/css-transitions-for-dynamically-created-dom-elements/" title="CSS transitions for dynamically created DOM elements">CSS transitions for dynamically created DOM elements</a></h1>
    
    








  



<time datetime="2012-09-23T20:00:00+02:00" pubdate data-updated="true">September, 23<span>rd</span> 2012</time>
  </header>
  <p><a href="https://developer.mozilla.org/en/CSS/CSS_transitions">CSS transitions</a> are
awesome. You can use them to easily animate the transition of one or multiple
CSS properties from a given state to another. But how does that work if your
element has just been created and inserted into the DOM dynamically?</p>

<p>Let&#8217;s take a look at this simple example:</p>

<figure class='code'> <div class="highlight"><pre><span class="nt">div</span> <span class="p">{</span>
  <span class="c">/* ... */</span>
  <span class="n">transition</span><span class="o">:</span> <span class="k">opacity</span> <span class="m">500</span><span class="n">ms</span><span class="p">;</span>
<span class="p">}</span>
</pre>
</div>
</figure>




<figure class='code'> <div class="highlight"><pre><span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">elem</span><span class="p">);</span>

<span class="c1">// Make the element fully transparent.</span>
<span class="nx">elem</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// Fade it in.</span>
<span class="nx">elem</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</pre>
</div>
</figure>


<p>We dynamically insert a new &lt;div> element into the DOM with its initial
opacity set to zero. Subsequently we want it to fade to full opacity.
This - as you might have guessed - does of course not work that way.</p>

<h2>How about a timeout?</h2>

<p>It is clear that we somehow need to make sure the initial state with zero
opacity is &#8220;applied&#8221; before trying to fade in:</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">elem</span><span class="p">);</span>

<span class="c1">// Make the element fully transparent.</span>
<span class="nx">elem</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// Make sure the initial opacity value is applied.</span>
<span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Fade it in.</span>
  <span class="nx">elem</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
</pre>
</div>
</figure>


<p>This is only marginally better. It seems to work with Webkit and Opera (and
maybe even IE) but not in Firefox (in 99% of the cases). Using setTimeout()
is a little too much overhead and nobody guarantees you that the style has
really been applied after some milliseconds. It may be unsupported and
unreliable, we need something better.</p>

<h2>getComputedStyle to the rescue</h2>

<p>There is another way to apply the element&#8217;s current style that even works
synchronously:</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">elem</span><span class="p">);</span>

<span class="c1">// Make the element fully transparent.</span>
<span class="nx">elem</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// Make sure the initial state is applied.</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">getComputedStyle</span><span class="p">(</span><span class="nx">elem</span><span class="p">).</span><span class="nx">opacity</span><span class="p">;</span>

<span class="c1">// Fade it in.</span>
<span class="nx">elem</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</pre>
</div>
</figure>


<p>Although it looks like we only query the current opacity value, getComputedStyle()
in combination with accessing a property value actually flushes all pending
style changes and forces the layout engine to compute our &lt;div>&#8217;s current
state. This workaround works in all major browsers and does not yield different
results like the setTimeout() approach.</p>

</article>



  <article class="post">
  <header class="article-header">
    
      <h1><a href="/blog/2012/08/snappy-fixing-new-tab-page-performance-regressions/" title="Snappy: Fixing new tab page performance regressions">Snappy: Fixing new tab page performance regressions</a></h1>
    
    








  



<time datetime="2012-08-14T12:00:00+02:00" pubdate data-updated="true">August, 14<span>th</span> 2012</time>
  </header>
  <p>As you probably already know, Firefox 13 introduced a neat new feature - the
<a href="/blog/2012/02/help-us-test-the-new-tab-page/">new tab page</a>.
We replaced the old blank page with a list of thumbnails of recently visited
sites. While the feature itself works great for many people it has definitely
made opening new tabs a little more noisy.</p>

<h2>Do not show loading indicators</h2>

<p>As we are now loading a real (although local) page, there are loading indicators
when opening a new tab. The throbber starts to spin and the tab title changes
to &#8220;Connecting…&#8221; until the page has loaded. That is a lot of unnecessary noise.</p>

<p>In <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=716108" title="Bug 716108 - [New Tab Page] Connecting… should not briefly flicker in the tab title when a new tab is opened">bug 716108</a>
(Firefox 17) we removed loading indicators for newly opened tabs. No spinning
throbber, no flickering tab label. It only is a very subtle change but the whole
action of opening a new tab feels a lot smoother again.</p>

<h2>Preload new tab pages in the background</h2>

<p>If you happen to have a slower machine you will notice that loading the new tab
page takes a little while. It is a normal HTML (and partly XUL) page that we
need to parse and render. As all tabs start out with a blank docShell you will
first see a white canvas that then is replaced by &#8220;about:newtab&#8221;. As a last step
all thumbnails will be loaded and drawn progressively.</p>

<p>Opening a new tab is a very frequent action so it should feel snappy and not get
in your way at all. As optimizing the parsing and rendering stages any further
is more than a non-trivial task I came up with a little trick in
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=753448" title="Bug 753448 - [New Tab Page] preload newtab pages in the background and swap them in when opening a new tab">bug 753448</a>.
The idea is to preload the new tab page in the background so it has already
loaded when users open a new tab. All we now have to do is switch docShells
and the new tab page gets shown instantly.</p>

<p>You can give it a try as it landed in yesterday&#8217;s Nightly (2012-08-14). Just go
to &#8220;about:config&#8221; and set &#8220;browser.newtab.preload&#8221; to &#8220;true&#8221;. This option is
not yet enabled by default as we first have to figure out some minor talos
regressions until it is ready for prime time.</p>

</article>



  <article class="post">
  <header class="article-header">
    
      <h1><a href="/blog/2012/04/are-we-small-yet/" title="Are we small, yet?">Are we small, yet?</a></h1>
    
    








  



<time datetime="2012-04-11T00:22:00+02:00" pubdate data-updated="true">April, 11<span>th</span> 2012</time>
  </header>
  <p>Lately, <a href="http://weblogs.mozillazine.org/asa/">Asa Dotzler</a> <a href="https://groups.google.com/forum/#!topic/mozilla.dev.apps.firefox/k7fzkhdt9io">posted to dev.apps.firefox</a> regarding the download size of Firefox:</p>

<blockquote><p>This evening I noticed that my full win32 mar update for Firefox was 21MB. That caused me to look at what our full win32 installer size was. I was a bit surprised to see it’s up to 17MB. When we shipped Firefox 1, our Windows installer build was 4.7MB. [&#8230;]</p>

<p>Firefox 12 is a 16.1 MB download.
Firefox 4 was a 12.0 MB download.
Firefox 3.6 was a 7.7 MB download.</p>

<p>In less than three years we’ve more than doubled in size. (fuller chart here <a href="http://grab.by/cSHA">http://grab.by/cSHA</a>)</p></blockquote>

<p>While there’s no doubt that adding new features and supporting new platforms are good reasons for increasing the build size it’s definitely a metric that impacts users. It hits them the hardest when downloading Firefox the first time, especially with slow internet connections. It still hits them every time we provide application updates.</p>

<p>To better illustrate the steady growth over the last few years I created <a href="http://www.arewesmallyet.com/">http://www.arewesmallyet.com/</a>. It’s updated daily, shows differences between nightly builds and links to the corresponding changelog if one would like to investigate the cause of increasing build sizes.</p>

<p><img src="/images/arewesmallyet.png" title="Screenshot of arewesmallyet.com" ></p>

<p>While this surely isn’t the most important battle we have right now I hope this will turn out useful to anyone willing to pick this up and tackle some build size optimizations.</p>

<p>GitHub: <a href="https://github.com/ttaubert/arewesmallyet">https://github.com/ttaubert/arewesmallyet</a></p>

</article>



  <article class="post">
  <header class="article-header">
    
      <h1><a href="/blog/2012/04/one-year-at-mozilla/" title="One year at Mozilla">One year at Mozilla</a></h1>
    
    








  



<time datetime="2012-04-09T13:28:00+02:00" pubdate data-updated="true">April, 9<span>th</span> 2012</time>
  </header>
  <p>You may already know the story of <a href="/blog/2012/01/how-i-became-a-firefox-contributor/">how I became a Firefox contributor</a>. Back in early April of 2011, having volunteered full-time for three months (a rather short time compared to other core contributors), I was given the opportunity to start as a paid contributor working for Mozilla.</p>

<p>Over the year I met a lot of great people and had the chance to visit our awesome offices in Mountain View, San Francisco and soon Toronto. I attended JSConf.eu, MozCamp and FOSDEM, with the JSDay yet to come.</p>

<p>But Mozilla isn’t about traveling or attending conferences. It’s about passion for open source, passion for the open web. Working for a non-profit, where decisions are driven by reason and mission, is something that not many software engineers will ever experience in their whole professional career. That’s only one of the reasons I’m really glad to be a part of the global Mozilla community.</p>

<p>Inspired by <a href="http://lucasr.org/2012/03/13/my-first-238-days-at-mozilla/">Lucas Rocha</a> I’ll end this post with some neat statistics about my contributions to the Mozilla project (we Germans love statistics):</p>

<p>I fixed 223 bugs and reviewed patches for 116. I pushed 417 changesets, 110 of them being merges between trees. I changed roughly 1367 files (31862 insertions(+), 19081 deletions(-)).</p>

</article>



  <article class="post">
  <header class="article-header">
    
      <h1><a href="/blog/2012/02/fighting-docshell-and-domwindow-leaks/" title="Fighting DocShell and DOMWindow leaks">Fighting DocShell and DOMWindow leaks</a></h1>
    
    








  



<time datetime="2012-02-27T19:13:00+01:00" pubdate data-updated="true">February, 27<span>th</span> 2012</time>
  </header>
  <p>In my post <a href="/blog/2011/09/leak-hunting-in-browser-chrome-mochitests/">Leak hunting in browser-chrome mochitests</a> I wrote about the measures we were considering to prevent regressing efforts to get rid of leaks in Firefox. Now that <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=683953" title="Bug 683953 - Browser-chrome mochitests should show statistics about leaked DOMWindows and DocShells">bug 683953</a> has landed we finally have a way to detect the leakage of whole DocShells and DOMWindows for the lifetime of the browser when running the browser-chrome mochitest suite.</p>

<h2>How does it work?</h2>

<p>While our browser-chrome mochitest suite runs we parse stdout to track starting and ending tests as well as the creation and removal of DocShells and DOMWindows. Just before the test suite shuts down we schedule a precise GC and wait until it’s completed. Any DOMWindows and DocShells still active are now counted as leaks and assigned to the tests that created them. Additionally we collect the URLs of DOMWindows to help debugging a bit.</p>

<h2>How does this prevent new leaks?</h2>

<p>We implemented a threshold of (currently) 130 leaks that must not be exceeded. If a test run leaks more than the limit we configured it goes orange and the patch should be backed out from the tree. These are the current numbers:</p>

<figure class='code'> <div class="highlight"><pre>Linux (64): 116 (116) leaks
OS X (64): 79 (89) leaks
Windows (XP): 120 (118) leaks
</pre>
</div>
</figure>


<p>Additionally, I filed <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=730797" title="Bug 730797 - Track number of DOMWindow/DocShell leaks and report improvements/regressions">bug 730797</a> to integrate these leaks statistics into our Talos infrastructure. So the leak count for each push will be recorded and compared to previous runs to make sure the numbers don’t regress. As the leak numbers differ quite heavily between OSes it makes sense to apply a custom threshold per OS, this will be implemented in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=730800" title="Bug 730800 - Apply per-OS threshold for shutdown leaks">bug 730800</a>.</p>

<h2>Why is there even a threshold?</h2>

<p>First, there are DocShells and DOMWindows that are intentionally kept alive until the browser closes. Second, it’s nearly impossible to bring all these leaks down to “zero” at once. It’s a list of bugs that have to be addressed and we will slowly decrease the threshold to approach “zaroo”.</p>

<p>Thanks to Dão who has been doing great work in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=658738" title="Bug 658738 - (bc-leaks) [meta] We seem to be leaking hundreds of windows until shutdown during browser-chrome tests">bug 658738</a> discovering all those leaks manually, which in the first place gave me the idea of automating it.</p>

</article>



  <article class="post">
  <header class="article-header">
    
      <h1><a href="/blog/2012/02/help-us-test-the-new-tab-page/" title="Help us test the New Tab Page!">Help us test the New Tab Page!</a></h1>
    
    








  



<time datetime="2012-02-10T19:11:00+01:00" pubdate data-updated="true">February, 10<span>th</span> 2012</time>
  </header>
  <p>Over the last weeks we worked hard on getting the New Tab Page into Firefox. It’s not quite ready yet but we need your help testing it. We enabled it by default on Nightly and decided to give it a week on Aurora to get feedback from those users as well.</p>

<p>Nightly: <a href="http://nightly.mozilla.org/">http://nightly.mozilla.org/</a><br/>
Aurora: <a href="https://www.mozilla.org/en-US/firefox/aurora/">https://www.mozilla.org/en-US/firefox/aurora/</a></p>

<p>We’ll disable it for Aurora again on February 16th (next Thursday). If you liked the feature and want it back then just set the preference ‘browser.newtab.url’ to ‘about:newtab’, ‘browser.newtabpage.enabled’ to ‘true’ and restart the browser. You can easily file bugs using the following link:</p>

<p><a href="https://bugzilla.mozilla.org/enter_bug.cgi?product=Firefox&amp;component=General&amp;short_desc=[New%20Tab%20Page]%20Summary%20of%20your%20problem">https://bugzilla.mozilla.org/enter_bug.cgi?product=Firefox&amp;component=General</a></p>

<p>Please make sure you don’t report a duplicate bug and check the dependencies of the original New Tab Page bug before filing – <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=455553" title="Bug 455553 - New Tab Page feature">bug 455553</a>.</p>

<p><img src="/images/newtab.png" title="Screenshot of the new tab page" ></p>

</article>



  <article class="post">
  <header class="article-header">
    
      <h1><a href="/blog/2012/01/how-i-became-a-firefox-contributor/" title="How I became a Firefox contributor">How I became a Firefox contributor</a></h1>
    
    








  



<time datetime="2012-01-19T19:04:00+01:00" pubdate data-updated="true">January, 19<span>th</span> 2012</time>
  </header>
  <p>December 2009. I’ve been a freelancer for quite some time now and decided to dedicate some weeks to something that always fascinated me: contributing to a big open source project. I started some smaller open source projects in the past (like <a href="https://github.com/ttaubert/video4linux-net">Video4Linux.Net</a> and <a href="https://github.com/ttaubert/ViGedit-Plus">ViGedit+</a>) and contributed every so often to Gentoo and the Linux kernel. I’ve always been a great fan of the open source movement and I felt that it’s time to give back some love.</p>

<p>I made a list of all the things that interested me and that I could possibly contribute to. Besides having things like Linux, ReactOS and Wine on the list I picked “Firefox” because it simply has been a loyal companion for years. I think I’ve used it first in version 1.5 and it was one of the most valuable tools that helped me to earn money, get my everyday work done and the most trivial: just browse and experience the web.</p>

<p>Some weeks before that I switched to Firefox 4.0 beta3/4 because that included the first version of Panorama (Tab Groups / TabCandy) that worked on Linux. I loved this feature but noticed that it was in an early stage and needed some fixes. I set up a Firefox build environment, went through Bugzilla to find open bugs, nagged people on IRC and was totally overwhelmed by the warm welcome and the appreciation of my work. This was something I did not at all experience when trying to contribute to other open source projects. Finally, the Panorama team and me managed to get this feature into shape and land it in Firefox 4, yay!</p>

<p>Long story short, I’m now a full-time contributor and love what I’m doing.</p>

</article>



<div class="pager">
  
    <li class="next"><a href="/blog/page/2/" title="Older posts">Older posts &rarr;</a></li>
  
  
</div>

        </section>
      </div>
      <div class="col span1"></div>
      <div class="col span2">
        <section class="well">
  <h1 class="sidebar-header">Recent posts</h1>
  <ul class="nav nav-list" id="recent-posts">
    
      <li><a title="getUserMedia() part 2: building an EyeToy-like mini-game" href="/blog/2012/10/getusermedia-part-2-building-an-eyetoy-like-mini-game/">getUserMedia() part 2: building an EyeToy-like mini-game</a></li>
    
      <li><a title="Building a live green screen with getUserMedia() and MediaStreams" href="/blog/2012/10/building-a-live-green-screen-with-getusermedia-and-mediastreams/">Building a live green screen with getUserMedia() and MediaStreams</a></li>
    
      <li><a title="Force Octopress/Jekyll to use a specific time zone" href="/blog/2012/09/force-octopress-jekyll-to-use-a-specific-time-zone/">Force Octopress/Jekyll to use a specific time zone</a></li>
    
      <li><a title="CSS transitions for dynamically created DOM elements" href="/blog/2012/09/css-transitions-for-dynamically-created-dom-elements/">CSS transitions for dynamically created DOM elements</a></li>
    
      <li><a title="Snappy: Fixing new tab page performance regressions" href="/blog/2012/08/snappy-fixing-new-tab-page-performance-regressions/">Snappy: Fixing new tab page performance regressions</a></li>
    
  </ul>
</section>
<section class="well">
  <h1 class="sidebar-header">Disclaimer</h1>
  <p id="disclaimer">The opinions expressed here are my own and do not necessarily represent those of current or past employers.</p>
</section>

      </div>
    </div>
  </div>

  <script defer>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-5257191-3']);
    _gaq.push(['_trackPageview']);
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = 'http://www.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
</body>
</html>

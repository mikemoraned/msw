
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Tim Taubert - Mozillian. Open Source enthusiast. Loves programming languages.</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    
    <meta name="description" content="Working with infinite sequences in JavaScript May, 6th 2013 Update: Please note that this post describes the current implementation in
SpiderMonkey &hellip;">
    <meta content="Tim Taubert" name="author">
    <link href="http://fonts.googleapis.com/css?family=Droid+Sans:400,700|PT+Sans" media="screen" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/screen.css" media="screen" rel="stylesheet" type="text/css">
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]-->
    <link href="/favicon.ico" rel="icon" type="image/ico">
    <link href="/atom.xml" rel="alternate" title="Tim Taubert" type="application/atom+xml">
    <script defer src="/javascripts/main.js"></script>
  </head>


<body>
  <div class="container-fluid">
    <div class="row-fluid">
      <div class="col span3">
        <header id="header">
  <h1><a href="/">Tim Taubert</a></h1>
  <a href="https://twitter.com/ttaubert" class="twitter-follow-button" data-show-count="false">Follow @ttaubert</a>
  <script defer>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</header>

        <section id="about">
  <h1 class="hidden">About me</h1>
  <strong>Mozillian.</strong>
  <strong>Open Source enthusiast.</strong>
  <strong>Loves Programming Languages.</strong>
</section>

        <nav>
  <h1 class="hidden">Main Navigation</h1>
  <ul class="nav-main">
    <li><a class="nav-main-link" title="About me" href="/about-me">about me</a></li>
    <li><a class="nav-main-link" title="Imprint" href="/imprint">imprint</a></li>
  </ul>
</nav>

      </div>
      <div id="main" class="col span6">
        <section>
          <h1 class="hidden">Content</h1>
          


  <article class="post">
  <header class="article-header">
    
      <h1><a href="/blog/2013/05/working-with-infinite-sequences-in-javascript/" title="Working with infinite sequences in JavaScript">Working with infinite sequences in JavaScript</a></h1>
    
    








  



<time datetime="2013-05-06T12:00:00+02:00" pubdate data-updated="true">May, 6<span>th</span> 2013</time>
  </header>
  <blockquote><p>Update: Please note that this post describes the current implementation in
SpiderMonkey. The final
<a href="http://wiki.ecmascript.org/doku.php?id=harmony:generators">ES6 specification</a>
will require generator functions to have a &#8216;*&#8217; token as in <em>function* nat()
{ &#8230; }</em>. The <em>flatten()</em> function from the last example could use <em>yield*</em> to
delegate instead of a nested loop.</p></blockquote>

<p>JavaScript comes with most of the little functional tools you need to work on
finite sequences that are usually implemented using Arrays. Array.prototype
includes a number of methods like <em>map()</em> and <em>filter()</em> that apply a given
function to all items of the Array and return the resulting new Array.</p>

<figure class='code'> <div class="highlight"><pre><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">].</span><span class="nx">map</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">// result: [2, 3, 4];</span>
</pre></div></figure>


<p>These tools however are not a good fit for infinite sequences as they always
consume the whole sequence at once to return a new one. Implementing infinite
sequences by yourself means you would have to come up with your own API that
clients need to adhere to. You often would keep state variables whose values
need to be maintained for the duration of the computation process.</p>

<h2>Generators to the rescue</h2>

<p>Using ES6
<a href="https://developer.mozilla.org/en-US/docs/JavaScript/Guide/Iterators_and_Generators">generators</a>
implementing the infinite sequence of all natural numbers turns out to be a
trivial task. We even have language support to iterate over them.</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">function</span> <span class="nx">nat</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">yield</span> <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">it</span> <span class="o">=</span> <span class="nx">nat</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">next</span><span class="p">(),</span> <span class="nx">it</span><span class="p">.</span><span class="nx">next</span><span class="p">(),</span> <span class="nx">it</span><span class="p">.</span><span class="nx">next</span><span class="p">());</span> <span class="c1">// prints 1 2 3</span>
</pre></div></figure>


<p>Now that we have a first infinite set we need a couple of functions that help us
working with, combining, and building new sequences.</p>

<h2>Mapping</h2>

<p>Let us start with <em>map()</em> - a function at the very heart of functional
programming. It builds a new sequence by applying a function to all elements of
a given sequence.</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">function</span> <span class="nx">map</span><span class="p">(</span><span class="nx">it</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="k">of</span> <span class="nx">it</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">yield</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></figure>


<p>Using the generator implementation of <em>map()</em> we can now easily write a function
called <em>squares()</em> that represents the set of squares of all natural numbers
(1², 2², 3², &#8230;, n²).</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">function</span> <span class="nx">squares</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">map</span><span class="p">(</span><span class="nx">nat</span><span class="p">(),</span> <span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">it</span> <span class="o">=</span> <span class="nx">squares</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">next</span><span class="p">(),</span> <span class="nx">it</span><span class="p">.</span><span class="nx">next</span><span class="p">(),</span> <span class="nx">it</span><span class="p">.</span><span class="nx">next</span><span class="p">());</span> <span class="c1">// prints 1 4 9</span>
</pre></div></figure>


<p>Using
<a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Statements/for...in">for&#8230;in</a>
instead of
<a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Statements/for...of">for&#8230;of</a>
works fine but using <em>of</em> has a neat advantage in that it properly iterates
Arrays as well. If you want to map values of a finite sequence you can just do
that.</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">var</span> <span class="nx">it</span> <span class="o">=</span> <span class="nx">map</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">next</span><span class="p">(),</span> <span class="nx">it</span><span class="p">.</span><span class="nx">next</span><span class="p">(),</span> <span class="nx">it</span><span class="p">.</span><span class="nx">next</span><span class="p">());</span> <span class="c1">// prints 1 4 9</span>
</pre></div></figure>


<h2>Filtering</h2>

<p>Another common task is filtering specific values from a sequence. Our custom
implementation of <em>filter()</em> takes an iterator and a predicate - the returned
sequence will consist of all items of the original one for which the predicate
holds.</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">function</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">it</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="k">of</span> <span class="nx">it</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">yield</span> <span class="nx">x</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></figure>


<p>We can now use <em>filter()</em> to create the set of all even natural numbers.</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">function</span> <span class="nx">even</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">nat</span><span class="p">(),</span> <span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">it</span> <span class="o">=</span> <span class="nx">even</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">next</span><span class="p">(),</span> <span class="nx">it</span><span class="p">.</span><span class="nx">next</span><span class="p">(),</span> <span class="nx">it</span><span class="p">.</span><span class="nx">next</span><span class="p">());</span> <span class="c1">// prints 2 4 6</span>
</pre></div></figure>


<p>A common derivation from <em>filter()</em> is <em>filterNot()</em> that simply negates the
given predicate. We can use that to implement <em>even()</em> as well.</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">function</span> <span class="nx">filterNot</span><span class="p">(</span><span class="nx">it</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">it</span><span class="p">,</span> <span class="nx">x</span> <span class="o">=&gt;</span> <span class="o">!</span><span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">));</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">even</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">filterNot</span><span class="p">(</span><span class="nx">nat</span><span class="p">(),</span> <span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">x</span> <span class="o">%</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></figure>


<h2>Mersenne primes</h2>

<p>Suppose we were to implement a sequence that represents all
<a href="https://en.wikipedia.org/wiki/Mersenne_prime">Mersenne prime numbers</a>.
Mersenne primes are defined as prime numbers of the form M<sub>n</sub> = 2<sup>n</sup> - 1,
that is the set of all numbers of the given form that have no positive divisors
other than 1 and themselves. The set of Mersenne primes is
<a href="https://en.wikipedia.org/wiki/Lenstra%E2%80%93Pomerance%E2%80%93Wagstaff_conjecture">assumed to be infinite</a>
though this remains unproven, yet.</p>

<p>Let us first define some helper functions. <em>range(from, to)</em> and <em>forall()</em> are
common helpers in functional programming languages. <em>range()</em> returns the set of
natural numbers in a given range. <em>forall()</em> returns whether the given predicate
holds for all items in the sequence and should therefore only be used for finite
sequences.</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">function</span> <span class="nx">range</span><span class="p">(</span><span class="nx">lo</span><span class="p">,</span> <span class="nx">hi</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">lo</span> <span class="o">&lt;=</span> <span class="nx">hi</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">yield</span> <span class="nx">lo</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">forall</span><span class="p">(</span><span class="nx">it</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="k">of</span> <span class="nx">it</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></figure>


<p><em>mersenneNumbers()</em> is the set of all numbers of the form M<sub>n</sub> = 2<sup>n</sup> - 1.
<em>isPrime()</em> is a very simple and naive (and slow) primality checker that returns
whether the given candidate is divisible by any of the numbers in the range of
[2, candidate - 1]. We will use <em>isPrime()</em> as a filter to remove all non-prime
numbers from <em>mersenneNumbers()</em>.</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">function</span> <span class="nx">mersenneNumbers</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">map</span><span class="p">(</span><span class="nx">nat</span><span class="p">(),</span> <span class="nx">x</span> <span class="o">=&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">mersennePrimes</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nx">isPrime</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">forall</span><span class="p">(</span><span class="nx">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">n</span> <span class="o">%</span> <span class="nx">x</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">mersenneNumbers</span><span class="p">(),</span> <span class="nx">isPrime</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">it</span> <span class="o">=</span> <span class="nx">mersennePrimes</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">next</span><span class="p">(),</span> <span class="nx">it</span><span class="p">.</span><span class="nx">next</span><span class="p">(),</span> <span class="nx">it</span><span class="p">.</span><span class="nx">next</span><span class="p">());</span> <span class="c1">// prints 3 7 31</span>
</pre></div></figure>


<h2>Flattening</h2>

<p>As a last example we will implement a function that flattens nested sequences.</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">function</span> <span class="nx">flatten</span><span class="p">(</span><span class="nx">it</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="k">of</span> <span class="nx">it</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;[object Generator]&quot;</span> <span class="o">||</span>
        <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">x</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">y</span> <span class="k">of</span> <span class="nx">flatten</span><span class="p">(</span><span class="nx">x</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">yield</span> <span class="nx">y</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">yield</span> <span class="nx">x</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></figure>


<p>Note that using <em>for&#8230;of</em> comes in handy again as we can use it to iterate
over Arrays and generators. Using <em>flatten()</em> we can now do:</p>

<figure class='code'> <div class="highlight"><pre><span class="nx">flatten</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[[</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">]]]);</span> <span class="c1">// result: [1, 2, 3, 4, 5]</span>
</pre></div></figure>


<p>Combining <em>flatten()</em> and <em>map()</em> to <em>flatMap()</em> we can implement another very
common function that flattens the result of applying a given function to all
items of a sequence. Let us use it to re-build the set of all natural numbers
from the set of all even natural numbers.</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">function</span> <span class="nx">flatMap</span><span class="p">(</span><span class="nx">it</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">flatten</span><span class="p">(</span><span class="nx">map</span><span class="p">(</span><span class="nx">it</span><span class="p">,</span> <span class="nx">f</span><span class="p">));</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">it</span> <span class="o">=</span> <span class="nx">flatMap</span><span class="p">(</span><span class="nx">even</span><span class="p">(),</span> <span class="nx">x</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nx">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">x</span><span class="p">]);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">next</span><span class="p">(),</span> <span class="nx">it</span><span class="p">.</span><span class="nx">next</span><span class="p">(),</span> <span class="nx">it</span><span class="p">.</span><span class="nx">next</span><span class="p">());</span> <span class="c1">// prints 1 2 3</span>
</pre></div></figure>


<h2>Generators are powerful</h2>

<p>It is quite obvious that studying ES6 generators really repays. They are a very
powerful language construct and I personally cannot wait until they are
available in V8/Node.js as well. They will be in the toolbox of every
professional JavaScript developer soon and I am sure we can count on the
community to come up with lots of great uses and libraries.</p>

</article>



  <article class="post">
  <header class="article-header">
    
      <h1><a href="/blog/2013/05/stop-iteration-time/" title="Stop. Iteration time!">Stop. Iteration time!</a></h1>
    
    








  



<time datetime="2013-05-03T18:00:00+02:00" pubdate data-updated="true">May, 3<span>rd</span> 2013</time>
  </header>
  <p>You have probably already heard of
<a href="https://developer.mozilla.org/en-US/docs/JavaScript/Guide/Iterators_and_Generators">generators and iterators</a>
coming to a browser near you. They have been available in Firefox for a long
time and are used extensively all over the Mozilla code base. The V8 team
will implement iterators and generators
<a href="http://code.google.com/p/v8/issues/detail?id=2355">once ES6 has been finalized</a>.</p>

<p>This post describes the current implementation in SpiderMonkey and tries to
include the current state of the ES6 draft and discussions.</p>

<h2>A simple generator</h2>

<p>Let us take a look at a simple example of a generator function that represents
an infinite sequence containing all the numbers from 0 to <em>Number.MAX_VALUE</em>.
Once it reaches <em>MAX_VALUE</em> it will not increase any further but always return
the same number.</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">function</span> <span class="nx">myInfiniteGenerator</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">yield</span> <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">iter</span> <span class="o">=</span> <span class="nx">myInfiniteGenerator</span><span class="p">();</span>

<span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">iter</span><span class="p">.</span><span class="nx">next</span><span class="p">());</span>
<span class="p">}</span>
</pre></div></figure>


<p>Any object of the following shape is an
<a href="http://wiki.ecmascript.org/doku.php?id=harmony:iterators">iterator</a>:</p>

<figure class='code'> <div class="highlight"><pre><span class="p">{</span> <span class="nx">next</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nx">any</span> <span class="p">}</span>
</pre></div></figure>


<p>The <em>next()</em> method simply returns the item next in the sequence.</p>

<h2>Finite sequences</h2>

<p>As you surely noticed the generator of the first example produces iterators that
will never run out of items. The next example shows an iterator representing a
finite sequence:</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">function</span> <span class="nx">MyFiniteIterator</span><span class="p">(</span><span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cur</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">max</span> <span class="o">=</span> <span class="nx">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">MyFiniteIterator</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cur</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">cur</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">throw</span> <span class="nx">StopIteration</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></figure>


<p>The given code implements a custom iterator without writing a generator
function. Note that it throws <em>StopIteration</em> as soon as it reaches the maximum
value to signal that the sequence is exhausted. It is a lot more elegant to
implement the same sequence using a generator function:</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">function</span> <span class="nx">myFiniteGenerator</span><span class="p">(</span><span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">yield</span> <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></figure>


<p>Generator functions will automatically throw <em>StopIteration</em> when terminating.
So how should one consume iterators with finite sequences?</p>

<h2>Consuming sequences</h2>

<p>In Java for example, you would check <em>iter.hasNext()</em> and stop when it returns
false. In JavaScript however you need to use a <em>try&#8230;catch</em> statement to catch
<em>StopIteration</em> when it is being thrown.</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">var</span> <span class="nx">iter</span> <span class="o">=</span> <span class="nx">myFiniteGenerator</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

<span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">iter</span><span class="p">.</span><span class="nx">next</span><span class="p">());</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span> <span class="k">if</span> <span class="nx">e</span> <span class="o">===</span> <span class="nx">StopIteration</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></figure>


<p>You might wonder if there is a better way to do this and indeed there is. Using
<em>for&#8230;in</em> or <em>for&#8230;of</em> you do not have to catch <em>StopIteration</em> yourself, the
JavaScript engine will do it for you. As soon as the sequence is exhausted the
loop will terminate normally without the exception being propagated:</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">var</span> <span class="nx">iter</span> <span class="o">=</span> <span class="nx">myFiniteGenerator</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">iter</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></figure>


<h2>StopIteration is special</h2>

<p><em>StopIteration</em> actually is a standard variable that is bound to an object of
class <em>StopIteration</em>. It is an ordinary object with no properties of its own
and it is not a constructor function.</p>

<figure class='code'> <div class="highlight"><pre><span class="k">try</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="nx">StopIteration</span><span class="p">;</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span> <span class="k">if</span> <span class="nx">e</span> <span class="k">instanceof</span> <span class="nx">StopIteration</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// This works because:</span>
  <span class="nx">StopIteration</span> <span class="k">instanceof</span> <span class="nx">StopIteration</span> <span class="o">===</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></figure>


<p>As <em>StopIteration</em> is a singleton of type <em>StopIteration</em> you can also catch it
by checking for equality:</p>

<figure class='code'> <div class="highlight"><pre><span class="k">try</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="nx">StopIteration</span><span class="p">;</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span> <span class="k">if</span> <span class="nx">e</span> <span class="o">===</span> <span class="nx">StopIteration</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ... handle exception</span>
<span class="p">}</span>
</pre></div></figure>


<h2>StopIteration is mutable</h2>

<p>You should be aware that <em>StopIteration</em> is a mutable global. Just like
<em>undefined</em> it can be modified to hold any other value. If you write a library
and want to shield against modifications from outside you can use this neat
little trick I found on
<a href="http://calculist.blogspot.de/2008/04/how-to-spell-stopiteration.html">Dave Herman&#8217;s blog</a>:</p>

<figure class='code'> <div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="k">try</span><span class="p">{(</span><span class="kd">function</span><span class="p">(){</span><span class="kc">true</span><span class="o">||</span><span class="p">(</span><span class="k">yield</span><span class="p">)})().</span><span class="nx">next</span><span class="p">()}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="k">return</span> <span class="nx">e</span><span class="p">}})()</span>
</pre></div></figure>


<p>The inner function is a generator that terminates immediately and therefore will
throw a <em>StopIteration</em>. The outer function simply catches and returns it.</p>

<h2>StopIteration may become a constructor</h2>

<p>The current
<a href="http://wiki.ecmascript.org/doku.php?id=harmony:iterators#stopiteration">iterator strawman</a>
states that <em>StopIteration</em> will become a constructor to maintain compatibility
with generator functions returning values.</p>

<figure class='code'> <div class="highlight"><pre><span class="nx">Iter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cur</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">cur</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">stop</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StopIteration</span><span class="p">();</span>
  <span class="nx">stop</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s2">&quot;sequence exhausted&quot;</span><span class="p">;</span>
  <span class="k">throw</span> <span class="nx">stop</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></figure>


<p>The equality check from above would not work anymore so it might be better to
just use <em>instanceof</em>.</p>

<h2>StopIteration may not be part of ES6</h2>

<p>The Python way of throwing to denote the end of a sequence is backwards
compatible with old ECMAScript versions but there seem to be
<a href="https://mail.mozilla.org/pipermail/es-discuss/2013-February/028668.html">people</a>
<a href="https://mail.mozilla.org/pipermail/es-discuss/2013-March/028937.html">not happy</a>
<a href="http://esdiscuss.org/notes/2013-03-12">with the current proposal</a>.
While I can&#8217;t tell whether <em>StopIteration</em> is really to be removed a couple of
alternative suggestions have been made:</p>

<h3>Introduce a keyword to end a frame</h3>

<p>To not misuse exceptions for normal control flow ES6 could introduce a
<em>stopiteration</em> or <em>endframe</em> keyword that would end the current frame with
an optional return value. The obvious downside is that it is probably not
backwards compatible.</p>

<figure class='code'> <div class="highlight"><pre><span class="nx">Iter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cur</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">cur</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">stopiteration</span> <span class="p">[</span><span class="nx">reason</span><span class="p">];</span>
  <span class="c1">// or endframe [reason];</span>
<span class="p">};</span>
</pre></div></figure>


<h3>Add an iterator.hasNext() method</h3>

<p>Just like Java the iterator API could consist of the two methods <em>next()</em> and
<em>hasNext()</em>. The client would then need to check <em>hasNext()</em> every time before
calling <em>next()</em>.</p>

<figure class='code'> <div class="highlight"><pre><span class="nx">Iter</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">hasNext</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">cur</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">max</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">next</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasNext</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">cur</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;sequence exhausted&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></div></figure>


<h3>Let next() always return an object</h3>

<p>Custom iterators would be required to implement a single method but would not
need to throw. Instead they would return an object with the property <em>done</em> set
to true to indicate that the sequence has ended. The <em>value</em> property would be
used to store values passed to <em>yield</em> or <em>return</em> in a generator function.</p>

<figure class='code'> <div class="highlight"><pre><span class="p">{</span>
  <span class="nx">next</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="nx">done</span><span class="o">:</span> <span class="kc">false</span> <span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">any</span> <span class="p">}</span>
          <span class="o">|</span> <span class="p">{</span> <span class="nx">done</span><span class="o">:</span> <span class="kc">true</span><span class="p">[,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">any</span><span class="p">]</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div></figure>


<h3>Food for thought</h3>

<p>This is in no way a complete list of possibilities or proposals that were
brought up on <a href="http://mail.mozilla.org/pipermail/es-discuss/">es-discuss</a> so
please make up your own mind about the current iterators implementation and the
suggested improvements.</p>

<h2>The future is bright</h2>

<p>Whether or not <em>StopIteration</em> will end up in ES6, generators and iterators are
great and you should make sure to be prepared when they become available in
modern browsers as well as on Node.js.</p>

<p>I concentrated particularly on <em>StopIteration</em> but there are
<a href="http://jlongster.com/2012/10/05/javascript-yield.html">lots of</a>
<a href="http://ejohn.org/blog/javascript-18-progress/">great</a>
<a href="http://bjouhier.wordpress.com/2012/05/18/asynchronous-javascript-with-generators-an-experiment/">posts</a>
out there that go way more into depth about generators and their usage. Make
sure to also take a look at libraries like <a href="http://taskjs.org/">Task.js</a> that
combines generators with promises to cooperative tasks.</p>

</article>



  <article class="post">
  <header class="article-header">
    
      <h1><a href="/blog/2013/02/getusermedia-part-3-simple-motion-detection-in-a-live-video/" title="getUserMedia() part 3: simple motion detection in a live video">getUserMedia() part 3: simple motion detection in a live video</a></h1>
    
    








  



<time datetime="2013-02-27T12:00:00+01:00" pubdate data-updated="true">February, 27<span>th</span> 2013</time>
  </header>
  <p>Now that you should already know how to build a
<a href="/blog/2012/10/building-a-live-green-screen-with-getusermedia-and-mediastreams/">live green screen</a>
and an
<a href="/blog/2012/10/getusermedia-part-2-building-an-eyetoy-like-mini-game/">EyeToy-like mini-game</a>
using nothing but plain JavaScript and a modern browser supporting WebRTC, let
us move on to another interesting example: simple motion detection in a live
video.</p>

<h2>The initialization code</h2>

<p>To detect motion in a video we need to compare at least two frames. We will use
<a href="https://developer.mozilla.org/en-US/docs/JavaScript_typed_arrays">typed arrays</a>
to store the lightness data of the previous frames:</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">function</span> <span class="nx">initialize</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ... code to initialize the canvas and video elements ...</span>

  <span class="c1">// Prepare buffers to store lightness data.</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">buffers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">width</span> <span class="o">*</span> <span class="nx">height</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="c1">// Get the webcam&#39;s stream.</span>
  <span class="nx">nav</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">({</span><span class="nx">video</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="nx">startStream</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{});</span>
<span class="p">}</span>
</pre></div></figure>


<p>We want two frame buffers - a single one results in a heavily
flickering motion video but the more frames we store the more motion blur
we will see. Two seems like a good value for demonstration purposes.</p>

<h2>Illustrating lightness changes</h2>

<p>The main <em>draw()</em> function from
<a href="/blog/2012/10/building-a-live-green-screen-with-getusermedia-and-mediastreams/">part 1</a>
did not change except that we now call <em>markLightnessChanges()</em> for every frame.
This is also the probably most interesting function of the whole demo:</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">function</span> <span class="nx">markLightnessChanges</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Pick the next buffer (round-robin).</span>
  <span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="nx">buffers</span><span class="p">[</span><span class="nx">bufidx</span><span class="o">++</span> <span class="o">%</span> <span class="nx">buffers</span><span class="p">.</span><span class="nx">length</span><span class="p">];</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">,</span> <span class="nx">j</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Determine lightness value.</span>
    <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">lightnessValue</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">data</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="nx">data</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>

    <span class="c1">// Set color to black.</span>
    <span class="nx">data</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// Full opacity for changes.</span>
    <span class="nx">data</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">*</span> <span class="nx">lightnessHasChanged</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">current</span><span class="p">);</span>

    <span class="c1">// Store current lightness value.</span>
    <span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">current</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></figure>


<p>We determine the lightness value of every pixel in the canvas and compare it
to its values in the previously captured frames. If the difference to one of
those buffers exceeds a specific threshold the pixel will be black, if not it
becomes transparent.</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">function</span> <span class="nx">lightnessHasChanged</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">buffers</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">value</span> <span class="o">-</span> <span class="nx">buffer</span><span class="p">[</span><span class="nx">index</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre></div></figure>


<h2>Blend mode difference</h2>

<p>The simple method we use to detect motion is called a
<a href="http://en.wikipedia.org/wiki/Blend_modes#Difference">blend mode difference</a>.
That is a quite fancy word to say: we compare two images (also called layers
or frames) by putting them on top of each other and subtracting the bottom from
the top layer. In this example we do it for every pixel&#8217;s L-value of the
<a href="https://en.wikipedia.org/wiki/HSL_and_HSV">HSL color model</a>.</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">function</span> <span class="nx">lightnessValue</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">b</span><span class="p">))</span> <span class="o">/</span> <span class="mi">255</span> <span class="o">*</span> <span class="mi">50</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></figure>


<p>If the current frame is identical to the previous one, the lightness
difference will be exactly zero for all pixels. If the frames differ because
something in that picture has moved then there is a good chance that lightness
values change where motion occured. A small threshold ensures that we ignore
noise in the signal.</p>

<h2>Demo and screencast</h2>

<p>That is all! Take a look at the <a href="/demos/motion-detection/">live demo</a> or watch
the screencast below:</p>

<iframe class="embed embed-space"
 src="http://player.vimeo.com/video/60650211?title=1&amp;byline=1&amp;portrait=1"
 width="500" height="195" frameborder="0"
 webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>


<p>You can create some really great demos with this simple technique. Here is a
neat one of
<a href="http://www.soundstep.com/blog/experiments/jsdetection/">a xylophone you can play by waving your hands</a>
(which unfortunately does not work in Firefox).</p>

<p>Whatever your ideas may be, I encourage you to fiddle around with the small
demos I provided in my three getUserMedia() examples so far and let me know if
you built something amazing!</p>

</article>



  <article class="post">
  <header class="article-header">
    
      <h1><a href="/blog/2013/02/note-to-myself-dont-be-lazy/" title="Note to myself: Don't be lazy">Note to myself: Don&#8217;t be lazy</a></h1>
    
    








  



<time datetime="2013-02-25T12:00:00+01:00" pubdate data-updated="true">February, 25<span>th</span> 2013</time>
  </header>
  <p>Back in October 2012 I wrote two blog posts,
<a href="/blog/2012/10/building-a-live-green-screen-with-getusermedia-and-mediastreams/">getUserMedia part 1</a>
and <a href="/blog/2012/10/getusermedia-part-2-building-an-eyetoy-like-mini-game/">part 2</a>,
including demos which unfortunately would run in Firefox, only. I did not
explicitly want to be exclusive but I think I just did not feel like looking up
why my code did not work in Opera and why exactly webkitGetUserMedia() behaved
differently than mozGetUserMedia(). I was being lazy.</p>

<p>I also intended to mix in a couple of nice JavaScript features, like
block-scoped variable definitions with
<a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Statements/let">let</a>,
<a href="https://developer.mozilla.org/en-US/docs/JavaScript/New_in_JavaScript/1.7">destructuring assignments</a>
or <a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/Set">Sets</a>
(did I just do it again?). In hindsight this does not really make sense as I
should not expect visitors to want to learn about cutting-edge JavaScript
features when viewing a getUserMedia() post.</p>

<p>Before finishing my third piece on getUserMedia() I decided to update the demos
of my older posts to run in any modern browser. I also seized the chance to
overhaul code examples which did not adhere to my coding standards anymore.</p>

<p>If you should ever be in a similar situation - please take a couple of minutes
to write code that runs in all modern browsers so people can enjoy your demos in
their browser of choice. Please don&#8217;t be lazy.</p>

</article>



  <article class="post">
  <header class="article-header">
    
      <h1><a href="/blog/2012/10/getusermedia-part-2-building-an-eyetoy-like-mini-game/" title="getUserMedia() part 2: building an EyeToy-like mini-game">getUserMedia() part 2: building an EyeToy-like mini-game</a></h1>
    
    








  



<time datetime="2012-10-18T22:00:00+02:00" pubdate data-updated="true">October, 18<span>th</span> 2012</time>
  </header>
  <p>This post is a follow-up to my previous one about
<a href="/blog/2012/10/building-a-live-green-screen-with-getusermedia-and-mediastreams/">building a live green screen with getUserMedia() and MediaStreams</a>.
If you have not read it yet, this might be a good time. We will extend the small
example to build an EyeToy-like mini-game.</p>

<h2>Some additions</h2>

<figure class='code'> <div class="highlight"><pre><span class="kd">var</span> <span class="nx">video</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">,</span> <span class="nx">context</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">revealed</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">initialize</span><span class="p">()</span> <span class="p">{</span>
</pre></div></figure>


<p>First, we will add a variable called <em>revealed</em> that keeps track of all pixels
that have already been revealed by holding a green object in front of the
camera. Instead of <em>replaceGreen()</em> we will call our method <em>revealGreen()</em>
from now on:</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">function</span> <span class="nx">revealGreen</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">width</span> <span class="o">*</span> <span class="nx">height</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">,</span> <span class="nx">j</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// This pixel has already been revealed.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">revealed</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">data</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div></figure>


<p>When iterating over all of the canvas&#8217; pixels we check whether the current index
is marked as revealed. If so we do not need to check its color but set its
opacity to zero and continue with the next iteration.</p>

<figure class='code'> <div class="highlight"><pre>    <span class="c1">// Convert from RGB to HSL...</span>
    <span class="kd">var</span> <span class="nx">hsl</span> <span class="o">=</span> <span class="nx">rgb2hsl</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">data</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="nx">data</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>
    <span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="nx">hsl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">hsl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">hsl</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

    <span class="c1">// ... and check if we have a somewhat green pixel.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">h</span> <span class="o">&gt;=</span> <span class="mi">90</span> <span class="o">&amp;&amp;</span> <span class="nx">h</span> <span class="o">&lt;=</span> <span class="mi">160</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span> <span class="o">&gt;=</span> <span class="mi">25</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span> <span class="o">&lt;=</span> <span class="mi">90</span> <span class="o">&amp;&amp;</span> <span class="nx">l</span> <span class="o">&gt;=</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> <span class="nx">l</span> <span class="o">&lt;=</span> <span class="mi">75</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">data</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">revealed</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></figure>


<p>If the pixel has not been revealed yet but is a green one, we make it
transparent like before and mark it to stay that way.</p>

<h2>Demo and screencast</h2>

<p>That is all! Take a look at the <a href="/demos/eye-toy/">live demo</a> or watch the
screencast below:</p>

<iframe class="embed"
 src="http://player.vimeo.com/video/51703468?title=1&amp;byline=1&amp;portrait=1"
 width="500" height="195" frameborder="0"
 webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>


<h2>I know&#8230;</h2>

<p>&#8230; this is not much of a game but rather a small demo one could turn into a
mini-game with little effort. Play around with the code and see what you can
come up with!</p>

</article>



  <article class="post">
  <header class="article-header">
    
      <h1><a href="/blog/2012/10/building-a-live-green-screen-with-getusermedia-and-mediastreams/" title="Building a live green screen with getUserMedia() and MediaStreams">Building a live green screen with getUserMedia() and MediaStreams</a></h1>
    
    








  



<time datetime="2012-10-17T20:00:00+02:00" pubdate data-updated="true">October, 17<span>th</span> 2012</time>
  </header>
  <p>While recently watching a talk about the new WebRTC features I was reminded of
Paul Rouget&#8217;s great
<a href="https://developer.mozilla.org/samples/video/chroma-key/index.xhtml">green screen demo</a>
and thought that this would be a cool thing to have for live video as well.
Let us build a live green screen!</p>

<h2>The markup</h2>

<figure class='code'> <div class="highlight"><pre><span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;video</span> <span class="na">id=</span><span class="s">&quot;v&quot;</span> <span class="na">width=</span><span class="s">&quot;320&quot;</span> <span class="na">height=</span><span class="s">&quot;240&quot;</span><span class="nt">&gt;&lt;/video&gt;</span>
  <span class="nt">&lt;canvas</span> <span class="na">id=</span><span class="s">&quot;c&quot;</span> <span class="na">width=</span><span class="s">&quot;320&quot;</span> <span class="na">height=</span><span class="s">&quot;240&quot;</span><span class="nt">&gt;&lt;/canvas&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</pre></div></figure>


<p>Those are the parts we need. A &lt;video> element that plays the media stream
and a canvas we will use to read and transform image data.</p>

<h2>The JavaScript</h2>

<figure class='code'> <div class="highlight"><pre><span class="kd">function</span> <span class="nx">initialize</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Get the webcam&#39;s stream.</span>
  <span class="nx">navigator</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">({</span><span class="nx">video</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="nx">startStream</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">startStream</span><span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">video</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">stream</span><span class="p">);</span>
  <span class="nx">video</span><span class="p">.</span><span class="nx">play</span><span class="p">();</span>

  <span class="c1">// Ready! Let&#39;s start drawing.</span>
  <span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">draw</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></figure>


<p>We call <a href="https://developer.mozilla.org/en-US/docs/WebRTC/navigator.getUserMedia">navigator.getUserMedia()</a>
and pass <em>{video: true}</em> as the first argument which indicates that we want to
receive a video stream. We assign the MediaStream to the video&#8217;s <em>.src</em> property
to connect it to the &lt;video> element.</p>

<p>The video starts playing (which means the camera will be activated and you will
see your webcam&#8217;s live video) and we request an animation frame using the
<a href="https://developer.mozilla.org/en-US/docs/DOM/window.requestAnimationFrame">requestAnimationFrame() API</a>.
This is perfect for drawing to our canvas as the browser schedules the next
repaint and we will be called immediately before that happens. Now for the last
and most important part of our green screen:</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">function</span> <span class="nx">draw</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">frame</span> <span class="o">=</span> <span class="nx">readFrame</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">frame</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">replaceGreen</span><span class="p">(</span><span class="nx">frame</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">putImageData</span><span class="p">(</span><span class="nx">frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Wait for the next frame.</span>
  <span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">draw</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">replaceGreen</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">,</span> <span class="nx">j</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Convert from RGB to HSL...</span>
    <span class="kd">var</span> <span class="nx">hsl</span> <span class="o">=</span> <span class="nx">rgb2hsl</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">data</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="nx">data</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>
    <span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="nx">hsl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">hsl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">hsl</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

    <span class="c1">// ... and check if we have a somewhat green pixel.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">h</span> <span class="o">&gt;=</span> <span class="mi">90</span> <span class="o">&amp;&amp;</span> <span class="nx">h</span> <span class="o">&lt;=</span> <span class="mi">160</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span> <span class="o">&gt;=</span> <span class="mi">25</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span> <span class="o">&lt;=</span> <span class="mi">90</span> <span class="o">&amp;&amp;</span> <span class="nx">l</span> <span class="o">&gt;=</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> <span class="nx">l</span> <span class="o">&lt;=</span> <span class="mi">75</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">data</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></figure>


<p>What happens here is actually quite simple: we read the current video frame and
extract its image data. We then iterate over all pixels in the frame and check
if we found a green one - if so its opacity byte is set to zero, which means
fully transparent. The manipulated image data is put back into the canvas and
we are done for now until the next animation frame is ready.</p>

<h2>The demo</h2>

<p>Take a look at the <a href="/demos/green-screen/">live demo</a>, you will need a recent
Firefox/Chrome/Opera build. Make sure that getUserMedia() support is enabled
in your browser of choice. Hold a green object in front of the the camera and
try it out yourself. Your camera and light setup is probably very different
from mine so you might need to adjust the color check a little to make it work.
Alternatively, here is a screencast of the demo:</p>

<iframe class="embed"
 src="http://player.vimeo.com/video/51593914?title=1&amp;byline=1&amp;portrait=1"
 width="500" height="191" frameborder="0"
 webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>


<h2>The end</h2>

<p>This is an admittedly very simple example of a green screen but you can use
this little template to manipulate your webcam&#8217;s live video stream and build all
kinds of fancy demos with it.</p>

</article>



  <article class="post">
  <header class="article-header">
    
      <h1><a href="/blog/2012/09/force-octopress-jekyll-to-use-a-specific-time-zone/" title="Force Octopress/Jekyll to use a specific time zone">Force Octopress/Jekyll to use a specific time zone</a></h1>
    
    








  



<time datetime="2012-09-25T15:00:00+02:00" pubdate data-updated="true">September, 25<span>th</span> 2012</time>
  </header>
  <p>I could not be happier ever since I switched from Wordpress to Octopress.
I usually write and publish blog posts from where I live, Berlin. The time zone
here is CET (UTC+1). While recently visiting Mozilla&#8217;s HQ in Mountain View I
wrote another blog post just as usual and typed &#8220;rake generate&#8221; to turn my
Markdown files into static HTML files.</p>

<p>Looking at the output though, got me a little puzzled. All timestamps were
changed to be calculated off the PDT time zone. While certainly that is not a
big deal as they are still the same timestamps, I did not feel like changing
all of those every now and then I am somewhere in a different time zone.</p>

<p>If you want to use a &#8220;static&#8221; time zone when generating your page, do it like
this:</p>

<figure class='code'> <div class="highlight"><pre>TZ=CET rake generate
</pre></div></figure>


<p><strong>TL;DR</strong> - put your time zone into the TZ variable if you want to force Jekyll
to use a specific time zone when generating your HTML files.</p>

</article>



  <article class="post">
  <header class="article-header">
    
      <h1><a href="/blog/2012/09/css-transitions-for-dynamically-created-dom-elements/" title="CSS transitions for dynamically created DOM elements">CSS transitions for dynamically created DOM elements</a></h1>
    
    








  



<time datetime="2012-09-23T20:00:00+02:00" pubdate data-updated="true">September, 23<span>rd</span> 2012</time>
  </header>
  <p><a href="https://developer.mozilla.org/en/CSS/CSS_transitions">CSS transitions</a> are
awesome. You can use them to easily animate the transition of one or multiple
CSS properties from a given state to another. But how does that work if your
element has just been created and inserted into the DOM dynamically?</p>

<p>Let&#8217;s take a look at this simple example:</p>

<figure class='code'> <div class="highlight"><pre><span class="nt">div</span> <span class="p">{</span>
  <span class="c">/* ... */</span>
  <span class="n">transition</span><span class="o">:</span> <span class="k">opacity</span> <span class="m">500</span><span class="n">ms</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></figure>




<figure class='code'> <div class="highlight"><pre><span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">elem</span><span class="p">);</span>

<span class="c1">// Make the element fully transparent.</span>
<span class="nx">elem</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// Fade it in.</span>
<span class="nx">elem</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</pre></div></figure>


<p>We dynamically insert a new &lt;div> element into the DOM with its initial
opacity set to zero. Subsequently we want it to fade to full opacity.
This - as you might have guessed - does of course not work that way.</p>

<h2>How about a timeout?</h2>

<p>It is clear that we somehow need to make sure the initial state with zero
opacity is &#8220;applied&#8221; before trying to fade in:</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">elem</span><span class="p">);</span>

<span class="c1">// Make the element fully transparent.</span>
<span class="nx">elem</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// Make sure the initial opacity value is applied.</span>
<span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Fade it in.</span>
  <span class="nx">elem</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
</pre></div></figure>


<p>This is only marginally better. It seems to work with Webkit and Opera (and
maybe even IE) but not in Firefox (in 99% of the cases). Using setTimeout()
is a little too much overhead and nobody guarantees you that the style has
really been applied after some milliseconds. It may be unsupported and
unreliable, we need something better.</p>

<h2>getComputedStyle to the rescue</h2>

<p>There is another way to apply the element&#8217;s current style that even works
synchronously:</p>

<figure class='code'> <div class="highlight"><pre><span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">elem</span><span class="p">);</span>

<span class="c1">// Make the element fully transparent.</span>
<span class="nx">elem</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// Make sure the initial state is applied.</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">getComputedStyle</span><span class="p">(</span><span class="nx">elem</span><span class="p">).</span><span class="nx">opacity</span><span class="p">;</span>

<span class="c1">// Fade it in.</span>
<span class="nx">elem</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</pre></div></figure>


<p>Although it looks like we only query the current opacity value, getComputedStyle()
in combination with accessing a property value actually flushes all pending
style changes and forces the layout engine to compute our &lt;div>&#8217;s current
state. This workaround works in all major browsers and does not yield different
results like the setTimeout() approach.</p>

</article>



  <article class="post">
  <header class="article-header">
    
      <h1><a href="/blog/2012/08/snappy-fixing-new-tab-page-performance-regressions/" title="Snappy: Fixing new tab page performance regressions">Snappy: Fixing new tab page performance regressions</a></h1>
    
    








  



<time datetime="2012-08-14T12:00:00+02:00" pubdate data-updated="true">August, 14<span>th</span> 2012</time>
  </header>
  <p>As you probably already know, Firefox 13 introduced a neat new feature - the
<a href="/blog/2012/02/help-us-test-the-new-tab-page/">new tab page</a>.
We replaced the old blank page with a list of thumbnails of recently visited
sites. While the feature itself works great for many people it has definitely
made opening new tabs a little more noisy.</p>

<h2>Do not show loading indicators</h2>

<p>As we are now loading a real (although local) page, there are loading indicators
when opening a new tab. The throbber starts to spin and the tab title changes
to &#8220;Connecting…&#8221; until the page has loaded. That is a lot of unnecessary noise.</p>

<p>In <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=716108" title="Bug 716108 - [New Tab Page] Connecting… should not briefly flicker in the tab title when a new tab is opened">bug 716108</a>
(Firefox 17) we removed loading indicators for newly opened tabs. No spinning
throbber, no flickering tab label. It only is a very subtle change but the whole
action of opening a new tab feels a lot smoother again.</p>

<h2>Preload new tab pages in the background</h2>

<p>If you happen to have a slower machine you will notice that loading the new tab
page takes a little while. It is a normal HTML (and partly XUL) page that we
need to parse and render. As all tabs start out with a blank docShell you will
first see a white canvas that then is replaced by &#8220;about:newtab&#8221;. As a last step
all thumbnails will be loaded and drawn progressively.</p>

<p>Opening a new tab is a very frequent action so it should feel snappy and not get
in your way at all. As optimizing the parsing and rendering stages any further
is more than a non-trivial task I came up with a little trick in
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=753448" title="Bug 753448 - [New Tab Page] preload newtab pages in the background and swap them in when opening a new tab">bug 753448</a>.
The idea is to preload the new tab page in the background so it has already
loaded when users open a new tab. All we now have to do is switch docShells
and the new tab page gets shown instantly.</p>

<p>You can give it a try as it landed in yesterday&#8217;s Nightly (2012-08-14). Just go
to &#8220;about:config&#8221; and set &#8220;browser.newtab.preload&#8221; to &#8220;true&#8221;. This option is
not yet enabled by default as we first have to figure out some minor talos
regressions until it is ready for prime time.</p>

</article>



  <article class="post">
  <header class="article-header">
    
      <h1><a href="/blog/2012/04/are-we-small-yet/" title="Are we small, yet?">Are we small, yet?</a></h1>
    
    








  



<time datetime="2012-04-11T00:22:00+02:00" pubdate data-updated="true">April, 11<span>th</span> 2012</time>
  </header>
  <p>Lately, <a href="http://weblogs.mozillazine.org/asa/">Asa Dotzler</a> <a href="https://groups.google.com/forum/#!topic/mozilla.dev.apps.firefox/k7fzkhdt9io">posted to dev.apps.firefox</a> regarding the download size of Firefox:</p>

<blockquote><p>This evening I noticed that my full win32 mar update for Firefox was 21MB. That caused me to look at what our full win32 installer size was. I was a bit surprised to see it’s up to 17MB. When we shipped Firefox 1, our Windows installer build was 4.7MB. [&#8230;]</p>

<p>Firefox 12 is a 16.1 MB download.
Firefox 4 was a 12.0 MB download.
Firefox 3.6 was a 7.7 MB download.</p>

<p>In less than three years we’ve more than doubled in size. (fuller chart here <a href="http://grab.by/cSHA">http://grab.by/cSHA</a>)</p></blockquote>

<p>While there’s no doubt that adding new features and supporting new platforms are good reasons for increasing the build size it’s definitely a metric that impacts users. It hits them the hardest when downloading Firefox the first time, especially with slow internet connections. It still hits them every time we provide application updates.</p>

<p>To better illustrate the steady growth over the last few years I created <a href="http://www.arewesmallyet.com/">http://www.arewesmallyet.com/</a>. It’s updated daily, shows differences between nightly builds and links to the corresponding changelog if one would like to investigate the cause of increasing build sizes.</p>

<p><img src="/images/arewesmallyet.png" title="Screenshot of arewesmallyet.com" ></p>

<p>While this surely isn’t the most important battle we have right now I hope this will turn out useful to anyone willing to pick this up and tackle some build size optimizations.</p>

<p>GitHub: <a href="https://github.com/ttaubert/arewesmallyet">https://github.com/ttaubert/arewesmallyet</a></p>

</article>



<div class="pager">
  
    <li class="next"><a href="/blog/page/2/" title="Older posts">Older posts &rarr;</a></li>
  
  
</div>

        </section>
      </div>
      <div class="col span1"></div>
      <div class="col span2">
        <section class="well">
  <h1 class="sidebar-header">Recent posts</h1>
  <ul class="nav nav-list" id="recent-posts">
    
      <li><a title="Working with infinite sequences in JavaScript" href="/blog/2013/05/working-with-infinite-sequences-in-javascript/">Working with infinite sequences in JavaScript</a></li>
    
      <li><a title="Stop. Iteration time!" href="/blog/2013/05/stop-iteration-time/">Stop. Iteration time!</a></li>
    
      <li><a title="getUserMedia() part 3: simple motion detection in a live video" href="/blog/2013/02/getusermedia-part-3-simple-motion-detection-in-a-live-video/">getUserMedia() part 3: simple motion detection in a live video</a></li>
    
      <li><a title="Note to myself: Don't be lazy" href="/blog/2013/02/note-to-myself-dont-be-lazy/">Note to myself: Don't be lazy</a></li>
    
      <li><a title="getUserMedia() part 2: building an EyeToy-like mini-game" href="/blog/2012/10/getusermedia-part-2-building-an-eyetoy-like-mini-game/">getUserMedia() part 2: building an EyeToy-like mini-game</a></li>
    
  </ul>
</section>
<section class="well">
  <h1 class="sidebar-header">Disclaimer</h1>
  <p id="disclaimer">The opinions expressed here are my own and do not necessarily represent those of current or past employers.</p>
</section>

      </div>
    </div>
  </div>

  <script defer>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-5257191-3']);
    _gaq.push(['_trackPageview']);
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = 'http://www.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
</body>
</html>
